<html>
  <head>
    <title>runeCube</title>
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/ar.js/2.1.1/aframe-ar.min.js"
      integrity="sha512-nAwVtZxAhVDCqw7hx/hHoOOrTfNQ+l4dnw5HvRrzeDE8SB3cW6ztoCUQmpeSCiL0ZGO9OfNMghJubNAQTx2Jzw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <style>
      body {
        min-height: 100vh;
        width: 100%;
        overflow: hidden;
      }
      #deviceInfo {
        font-size: 2rem;
        padding: 20px;
        background: #fff;
        color: #000;
        width: 300px;
        height: 300px;
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
      }
    </style>
  </head>
  <body>
    <!-- <div id="deviceInfo"></div> -->
    <audio
      id="themeSong"
      src="./assets/Sounds/theme_song.mp3"
      autoplay
      loop
    ></audio>
    <audio id="clickSound" src="./assets/Sounds/click_sound.mp3"></audio>

    <a-scene embedded arjs>
      <a-camera>
        <a-entity
          cursor="fuse: false; rayOrigin: mouse;"
          position="0 0 -1"
          color="red"
          raycaster="objects: .rune"
          geometry="primitive: ring; radiusInner: 0.02;
radiusOuter: 0.03"
          material="color: black; shader: flat"
        >
        </a-entity>
      </a-camera>
    </a-scene>

    <script>
      const camera = document.querySelector("a-camera");

      const deviceInfo = document.querySelector("#deviceInfo");
      const scene = document.querySelector("a-scene");
      let cameraPos = 10;
      const position = { x: 20, y: 10, z: -20 };
      let boxes;
      let alpha, gamma, beta;
      let color = ["red", "green", "yellow", "blue", "black"];
      let scale = { x: 30, y: 30, z: 30 };
      const clickSound = document.querySelector("#clickSound");
      window.onload = () => {
        let _interval;
        function moveCamera() {
          camera.setAttribute("position", `0 0 ${cameraPos}`);
          if (gamma > 60) {
            cameraPos += 15;
          } else {
            cameraPos -= 15;
          }
        }
        function startMove() {
          _interval = setInterval(moveCamera, 100);
        }
        function endMove() {
          clearInterval(_interval);
        }
        document.addEventListener("touchstart", () => {
          startMove();
        });
        document.addEventListener("touchend", () => {
          endMove();
        });
        //Generating 5 Elements at start
        for (let i = 0; i < 50; i++) {
          positionRandomizer(position);
          generateElement(scene, position, colorRandomizer(color), scale);
        }
        //Get all elements with rune class
        boxes = document.querySelectorAll(".rune");
        //This method adds click event for all boxes.
        onSpawn();
      };
      if (window.DeviceOrientationEvent) {
        window.addEventListener("deviceorientation", function (e) {
          let alpha = e.alpha;
          let gamma = e.gamma;
          let beta = e.beta;
          deviceInfo.innerText = `Alpha:  ${alpha.toFixed(
            4
          )}  Gamma: ${gamma.toFixed(4)} Beta: ${beta.toFixed(4)}`;
        });
      }

      //On Click we start animation, remove the element from Dom and spawn new one.
      function onSpawn() {
        boxes.forEach((element) => {
          element.addEventListener("click", (e) => {
            element.setAttribute("animation", {
              property: "scale",
              to: "0.1 0.1 0.1",
              easing: "easeOutElastic",
              dur: 1000,
            });
            clickSound.play();

            setTimeout(() => {
              scene.removeChild(e.target);
              //Randomize the Position object
              positionRandomizer(position);
              //Generate new element with different position and color;
              generateElement(scene, position, colorRandomizer(color), scale);
              boxes = document.querySelectorAll(".rune");
              onSpawn();
            }, 1000);
          });
        });
      }

      //Helper function to generate new element
      function generateElement(_scene, position, color, scale) {
        const newBox = document.createElement("a-box");
        newBox.setAttribute("class", "rune");
        newBox.setAttribute("position", position);
        newBox.setAttribute("scale", scale);
        newBox.setAttribute("color", color);
        newBox.setAttribute("animation", {
          property: "rotation",
          to: "180 360 0",
          loop: true,
          dur: 10000,
        });
        _scene.appendChild(newBox);
      }

      function positionRandomizer(_positionObj) {
        _positionObj.x = generateRandomNum(600, true);
        _positionObj.y = generateRandomNum(300, true);
        _positionObj.z = generateRandomNum(600, true);
      }
      function colorRandomizer(elArray) {
        return elArray[generateRandomNum(elArray.length, false)];
      }

      //Helper function to generate random number
      function generateRandomNum(range, sign) {
        if (sign) {
          return Math.floor(Math.random() * (range - range * -1) + -1 * range);
        } else {
          return Math.floor(Math.random() * range);
        }
      }
    </script>
  </body>
</html>
